<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CS416 Final Project</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    svg { width: 960px; height: 500px; }
    .bar { cursor: pointer; }
    .annotation { font-size: 14px; fill: black; font-weight: bold; }
    .back-button { cursor: pointer; color: blue; text-decoration: underline; margin-bottom: 20px; display: none; }
  </style>
</head>
<body>
  <h1>Gender Pay Gaps in STEM Occupations</h1>
  <div class="back-button" onclick="showOverview()" style="margin-bottom: 20px; cursor: pointer; color: blue; text-decoration: underline; display: none;">&larr; Back</div> 
  <div id="scene"></div>
  
  <script>
    const csvUrl = 'nsf-cleaned.csv';
    let rawData = [];
    let selectedCategory = null;

    const params = {
      currentScene: 'overview',
    };

    const margin = { top: 40, right: 20, bottom: 100, left: 80 };
    const width = 960 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    const fieldColors = d3.scaleOrdinal()
      .domain(['S&E', 'S&E-related', 'STEM middle-skill'])
      .range(['#53b87d', '#5359ad', '#b33e56']);

    
    function clearScene() {
      d3.select('#scene').html('');
    }   

    function addAnnotation(svg, text, x = width - 300, y = -20) {
      svg.append("text")
        .attr("class", "annotation")
        .attr("x", x)
        .attr("y", y)
        .text(text);
    }

    function addFieldLegend(svg, categories, colorScale, x=30, y=10) {
      // svg - the D3 SVG selection
      // categories - array of field names
      // colorScale - function taking field name => color
      // x, y - legend positioning
    
      const legend = svg.append('g')
        .attr('class', 'legend')
        .attr('transform', `translate(${x},${y})`);
    
      const size = 18;   // Box size
      const spacing = 6; // Spacing between items
    
      categories.forEach((cat, i) => {
        legend.append('rect')
          .attr('x', 0)
          .attr('y', i * (size + spacing))
          .attr('width', size)
          .attr('height', size)
          .attr('fill', colorScale(cat));
    
        legend.append('text')
          .attr('x', size + 8)
          .attr('y', i * (size + spacing) + size * 0.75)
          .attr('font-size', 14)
          .text(cat);
      });
    
      legend.append('text')
        .attr('x', 0)
        .attr('y', -8)
        .attr('font-size', 15)
        .attr('font-weight', 'bold')
        .text('Field Legend');
    }

    
    function showOverview() {
      params.currentScene = 'overview';
      d3.select('.back-button').style('display', 'none');
      clearScene();

      const container = d3.select('#scene');
      const svg = container.append('svg');
      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleBand()
        .domain(rawData.map(d => d.Occupation))
        .range([0, width])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([0, d3.max(rawData, d => d.All_Workers)]).nice()
        .range([height, 0]);

      g.append('g').call(d3.axisLeft(y));

      g.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll('text')
        .attr('transform', 'rotate(-45)')
        .style('text-anchor', 'end');

      g.selectAll('.bar')
        .data(rawData)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d.Occupation))
        .attr('y', d => y(d.All_Workers))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d.All_Workers))
        .attr('fill', d => fieldColors(d.Field));
        .on('click', (event, d) => showDetailScene(d));

      addAnnotation(g, "Click a bar to see occupation-level earnings.");
      addFieldLegend(svg, fieldColors.domain(), fieldColors, width - 180, 30);
    }

    function showDetailScene(d) {
      params.currentScene = 'detail';
      selectedCategory = d;
      d3.select('.back-button').style('display', 'block');
      clearScene();

      const container = d3.select('#scene');
      const svg = container.append('svg');
      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      g.append('text')
        .attr('x', 0)
        .attr('y', 0)
        .attr('font-size', 20)
        .text(d.Occupation);

      const annotations = [
        `All Workers: $${d.All_Workers}`,
        `Male: $${d.Male}`,
        `Female: $${d.Female}`,
        `Difference: $${d.Difference}`,
        `Statistically Significant: ${d.Significant === '*' ? 'Yes' : 'No'}`
      ];

      addAnnotation(g, `All Workers: $${d.All_Workers}`, 0, 40);
      addAnnotation(g, `Male: $${d.Male}`, 0, 70);
      addAnnotation(g, `Female: $${d.Female}`, 0, 100);
      addAnnotation(g, `Difference: $${d.Difference}`, 0, 130);
      addAnnotation(g, `Statistically Significant: ${d.Significant === '*' ? 'Yes' : 'No'}`, 0, 160);
      addAnnotation(g, 'Click below to compare occupations by significance.', 0, 220);

      container.append('button')
        .text('Compare by Significance')
        .on('click', showSignificanceScene);
    }

    function showScene3() {
      params.currentScene = 'significance';
      d3.select('.back-button').style('display', 'block');
      clearScene();

      const container = d3.select('#scene');
      const svg = container.append('svg');
      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const grouped = d3.groups(rawData, d => d.Significant === '*' ? 'Significant' : 'Not Significant');

      const x = d3.scaleBand()
        .domain(grouped.map(d => d[0]))
        .range([0, width])
        .padding(0.4);

      const y = d3.scaleLinear()
        .domain([0, d3.max(grouped, d => d[1].length)]).nice()
        .range([height, 0]);

      g.append('g').call(d3.axisLeft(y));

      g.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x));

      g.selectAll('.bar')
        .data(grouped)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d[0]))
        .attr('y', d => y(d[1].length))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d[1].length))
        .attr('fill', d => d[0] === 'Significant' ? '#ff7f0e' : '#1f77b4');

      addAnnotation(g, "Counts of occupations by significance.");
    }


    d3.csv(csvUrl, d => ({
      Occupation: d['Detailed occupations'],
      Field: d['Field'],
      All_Workers:  +d['All workers'],
      Male: +d['Male'],
      Female: +d['Female'],
      Difference: +d['Difference'],
      Significant: d['Significant']
    })).then(data => {
      rawData = data;
      showOverview();
    });
  </script>
</body>
</html>
