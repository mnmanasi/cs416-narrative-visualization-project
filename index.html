<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CS416 Final Project</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    svg { width: 960px; height: 500px; }
    .bar { cursor: pointer; }
    .annotation { font-size: 14px; fill: black; font-weight: bold; }
    .back-button { cursor: pointer; color: blue; text-decoration: underline; margin-bottom: 20px; display: none; }
  </style>
</head>
<body>
  <h1>Gender Pay Gaps in STEM Occupations</h1>
  <div class="back-button" onclick="goBack()" style="margin-bottom: 20px; cursor: pointer; color: blue; text-decoration: underline; display: none;">&larr; Back</div> 
  <div id="scene"></div>
  
  <script>
    const csvUrl = 'nsf-cleaned.csv';
    let rawData = [];
    let selectedCategory = null;

    const params = {
      currentScene: 'overview',
    };

    const margin = { top: 40, right: 20, bottom: 100, left: 80 };
    const width = 960 - margin.left - margin.right;
    const height = 500 - margin.top - margin.bottom;

    const fieldColors = d3.scaleOrdinal()
      .domain(['S&E', 'S&E-related', 'STEM middle-skill'])
      .range(['#53b87d', '#5359ad', '#b33e56']);

    
    function clearScene() {
      d3.select('#scene').html('');
    }   

    function goBack() {
      if (params.currentScene === 'detail') {
        showOverview();
      } else if (params.currentScene === 'compareField') {
        showDetailScene(selectedCategory);
      }
    }

    function addAnnotation(svg, text, x = width - 300, y = -20) {
      svg.append("text")
        .attr("class", "annotation")
        .attr("x", x)
        .attr("y", y)
        .text(text);
    }

    function addFieldLegend(svg, categories, colorScale, x=30, y=10) {    
      const legend = svg.append('g')
        .attr('class', 'legend')
        .attr('transform', `translate(${x},${y})`);
    
      const size = 18; 
      const spacing = 6;
    
      categories.forEach((cat, i) => {
        legend.append('rect')
          .attr('x', 0)
          .attr('y', i * (size + spacing))
          .attr('width', size)
          .attr('height', size)
          .attr('fill', colorScale(cat));
    
        legend.append('text')
          .attr('x', size + 8)
          .attr('y', i * (size + spacing) + size * 0.75)
          .attr('font-size', 14)
          .text(cat);
      });
    
      legend.append('text')
        .attr('x', 0)
        .attr('y', -8)
        .attr('font-size', 15)
        .attr('font-weight', 'bold')
        .text('Field Legend');
    }

    
    function showOverview() {
      params.currentScene = 'overview';
      d3.select('.back-button').style('display', 'none');
      clearScene();

      const container = d3.select('#scene');
      const svg = container.append('svg');
      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleBand()
        .domain(rawData.map(d => d.Occupation))
        .range([0, width])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([0, d3.max(rawData, d => d.All_Workers)]).nice()
        .range([height, 0]);

      g.append('g').call(d3.axisLeft(y));

      g.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll('text')
        .attr('transform', 'rotate(-45)')
        .style('text-anchor', 'end');

      g.selectAll('.bar')
        .data(rawData)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d.Occupation))
        .attr('y', d => y(d.All_Workers))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d.All_Workers))
        .attr('fill', d => fieldColors(d.Field))
        .on('click', d => showDetailScene(d));

      addAnnotation(g, "Click a bar to see occupation-level earnings.");
      addFieldLegend(svg, fieldColors.domain(), fieldColors, width - 180, 60);
    }

    function showDetailScene(d) {
      params.currentScene = 'detail';
      selectedCategory = d;
      console.log(d);
      d3.select('.back-button').style('display', 'block');
      clearScene();

      const container = d3.select('#scene');
      const svg = container.append('svg');
      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      g.append('text')
        .attr('x', 0)
        .attr('y', -10)
        .attr('font-size', 20)
        .text(d.Occupation);

      const genderData = [
        { gender: 'Male', value: d.Male },
        { gender: 'Female', value: d.Female }
      ];

      const x = d3.scaleBand()
        .domain(genderData.map(d => d.gender))
        .range([0, width / 3])
        .padding(0.4);

      const y = d3.scaleLinear()
        .domain([0, d3.max(genderData, d => d.value)]).nice()
        .range([height, 0]);

      g.append('g').call(d3.axisLeft(y));

      g.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x));

      console.log(genderData.map(d => d.gender));
      g.selectAll('.bar')
        .data(genderData)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d.gender))
        .attr('y', d => y(d.value))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d.value))
        .attr('fill', d => d.gender === 'Male' ? '#1f77b4' : '#f257ac')
        .on('click', d => {
          showFieldComparisonScene(d.gender);
        });

      addAnnotation(g, `Statistically Significant: ${d.Significant === '*' ? 'Yes' : 'No'}`, 0, height + 50);
      addAnnotation(g, `Click a bar to compare earnings in ${d.Field}`, 0, height + 80);
    }

    function showFieldComparisonScene(clickedGender) {
      params.currentScene = 'compareField';
      d3.select('.back-button').style('display', 'block');
      clearScene();

      const field = selectedCategory.Field;
      const genderField = clickedGender; // 'Male' or 'Female'
      const fieldData = rawData
        .filter(d => d.Field === field)
        .sort((a, b) => b[genderField] - a[genderField]);

      const container = d3.select('#scene');
      const svg = container.append('svg');
      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      const x = d3.scaleBand()
        .domain(fieldData.map(d => d.Occupation))
        .range([0, width])
        .padding(0.2);

      const y = d3.scaleLinear()
        .domain([0, d3.max(fieldData, d => d[genderField])]).nice()
        .range([height, 0]);

      const color = genderField === 'Male' ? '#1f77b4' : '#f257ac';

      g.append('g').call(d3.axisLeft(y));

      g.append('g')
        .attr('transform', `translate(0,${height})`)
        .call(d3.axisBottom(x))
        .selectAll('text')
        .attr('transform', 'rotate(-45)')
        .style('text-anchor', 'end');

      g.selectAll('.bar')
        .data(fieldData)
        .enter()
        .append('rect')
        .attr('class', 'bar')
        .attr('x', d => x(d.Occupation))
        .attr('y', d => y(d[genderField]))
        .attr('width', x.bandwidth())
        .attr('height', d => height - y(d[genderField]))
        .attr('fill', color);

      addAnnotation(g, `${genderField} earnings across ${field} occupations (sorted)`, 0, -10);
    }


    d3.csv(csvUrl, d => ({
      Occupation: d['Detailed occupations'],
      Field: d['Field'],
      All_Workers:  +d['All workers'],
      Male: +d['Male'],
      Female: +d['Female'],
      Difference: +d['Difference'],
      Significant: d['Significant']
    })).then(data => {
      rawData = data;
      showOverview();
    });
  </script>
</body>
</html>
